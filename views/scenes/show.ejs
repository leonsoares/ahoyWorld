<%- include("../partials/header.js") %>


<div class="row text-center" >
        
    <div class="col-md-3 col-sm-6 card">
        <div>
            <div class="thumbnail">
                <div class="card-title">
                        <h4><%= scene.name %> - <%= scene.location %></h4>
                </div>
                <img src="<%= scene.image %>" class="card-img-top"" alt="">

                <% if(currentUser && scene.author._id === currentUser._id){ %>
                    <h6 class="card-title"> Post By @<a href="/test%>"><%= scene.author.username%> test</a></h6>
                    <% } else{ %>
                    <h6 class="card-title"> Post By @<a href="/users/<%= scene.author.id%>"><%= scene.author.username%></a></h6>
                <% } %>
         
            </div>
            
        
                <p class="card-text"><%= scene.description %></p>
            
            
            <p class="card-text"><%= scene._id.getTimestamp() %></p>
            <%console.log(scene._id.getTimestamp().date) %>
        <!-- likes -->
        <div style="padding-bottom: 10px;">
                <form action="/scenes/<%= scene._id %>/like" method="POST">
                    <div class="btn-group">
                        <% if (currentUser && scene.likes.some(function (like) {
                            return like.equals(currentUser._id)
                        })) { %>
                            <button class="btn btn-sm btn-primary">
                                <i class="fas fa-thumbs-up"></i> Liked (<%= scene.likes.length %>)
                            </button>
                        <% } else { %>
                            <button class="btn btn-sm btn-secondary">
                                <i class="fas fa-thumbs-up"></i> Like (<%= scene.likes.length %>)
                            </button>
                        <% } %>
                        <button type="button" class="btn btn-sm btn-default" data-toggle="modal"
                                data-target="#sceneLikes">See more details
                        </button>
                    </div>
                </form>
            </div>


        <!-- comments -->

            <% scene.comments.forEach((comment) => { %>
            <div>
                <p class="card-text">
                    <a href="../users/<%=comment.author.id%>"><%= comment.author.username %></a> - <%= comment.text %>
                    
                    <% if(currentUser && comment.author.id.equals(currentUser._id)){ %>
                    <a class="btn btn-primary" href="/scenes/<%- scene._id%>/comments/<%-comment._id%>/edit">Edit</a>
                    <form action="/scenes/<%- scene._id%>/comments/<%-comment._id%>?_method=DELETE" method="POST">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                    <%  } %>
                </p>
            </div>
                <% }); %>

        </div>

        <a class="btn btn-primary" href="/scenes">Back</a>
        <a class="btn btn-primary" href="/scenes/<%- scene._id %>/comments/new">Add Comment</a>

        <% if(currentUser && scene.author.id.equals(currentUser._id)){ %>
            <a class="btn btn-primary" href="/scenes/<%- scene._id %>/edit">Edit</a>                
            <br>
            <form action="/scenes/<%=scene._id %>?_method=DELETE" method="POST" >
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>

        <%  } %>
        
    </div>  
</div>
<!--Review section-->
<div class="thumbnail">
        <div class="caption-full">
            <% if (scene.rating === 0) { %>
            <h5>
                <em>No reviews yet.</em>
            </h5>
            <% } else { %>
            <p>
                <span class="fa fa-star checked"></span>
                <span class="fa fa-star <% if (scene.rating > 1.5) { %> checked <% } %>"></span>
                <span class="fa fa-star <% if (scene.rating > 2.5) { %> checked <% } %>"></span>
                <span class="fa fa-star <% if (scene.rating > 3.5) { %> checked <% } %>"></span>
                <span class="fa fa-star <% if (scene.rating > 4.5) { %> checked <% } %>"></span>
                <em>(total reviews: <%= scene.reviews.length %>)</em>
            </p>
            <p>
                Current scene rating: <strong><%= scene.rating.toFixed(2) %></strong>
            </p>
            <p><h4>Latest reviews for this scene:</h4></p>
            <hr style="margin-top: 0;">
            <% scene.reviews.slice(0, 5).forEach(function(review){ %>
            <div class="row">
                <div class="col-md-3">
                    <%- '<span class="fa fa-star checked"></span>'.repeat(review.rating) %><%- '<span class="fa fa-star"></span>'.repeat(5 - review.rating) %>
                    <div>Review by: <strong><%= review.author.username %></strong></div>
                    <span><em><%= review.updatedAt.toDateString() %></em></span>
                </div>
                <div class="col-md-9">
                    <p style="text-align: justify; word-wrap: break-word;">
                        <%= review.text %>
                    </p>
                    <% if(currentUser && review.author.id.equals(currentUser._id)){ %>
                    <a class="btn btn-xs btn-warning"
                       href="/scenes/<%=scene._id %>/reviews/<%=review._id %>/edit">Edit</a>
                    <form id="delete-form" action="/scenes/<%=scene._id %>/reviews/<%=review._id %>?_method=DELETE" method="POST">
                        <input type="submit" class="btn btn-xs btn-danger" value="Delete">
                    </form>
                    <% } %>
                </div>
            </div>
            <hr>
            <% }); %>
            <div style="margin-bottom: 10px;">
                <h4><a href="/scenes/<%= scene._id %>/reviews"><i class="fa fa-search" aria-hidden="true"></i> See all reviews</a></h4>
            </div>
            <% } %>
            <div>
                <a class="btn btn-primary btn-lg 
                <% if (currentUser && scene.reviews.some(function (review) {
                    return review.author.id.equals(currentUser._id)})) { %> 
                    disabled <% } %>" href="/scenes/<%= scene._id %>/reviews/new">
                    Write a New Review</a>
            </div>
        </div>
    </div>

   <!-- scenes Likes Modal -->
   <div id="sceneLikes" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Scene likes: <%= scene.likes.length %></h4>
                </div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>Liked by:</th>
                        </tr>
                        </thead>
                        <tbody>
                        <% scene.likes.forEach(function(like) { %>
                            <tr>
                                <td><span class="badge"><i class="fas fa-user"></i></span> <%= like.username %></td>
                            </tr>
                        <% }); %>
                        <% if (scene.likes.length === 0) { %>
                            <tr>
                                <td><em>No likes yet.</em></td>
                            </tr>
                        <% } %>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<!-- map -->
    <div id="map"></div>

    <script>
            function initMap() {
              var lat = <%= scene.lat %>;
              var lng = <%= scene.lng %>;
              var center = {lat: lat, lng: lng };
              var map = new google.maps.Map(document.getElementById('map'), {
                  zoom: 8,
                  center: center,
                  scrollwheel: false
              });
              var contentString = `
                <strong><%= scene.name %><br />
                <%= scene.location %></strong>
                <p><%= scene.description %></p>
              `
              var infowindow = new google.maps.InfoWindow({
                content: contentString
              });
              var marker = new google.maps.Marker({
                  position: center,
                  map: map
              });
              marker.addListener('click', function() {
                infowindow.open(map, marker);
              });
            }
          </script>
          <script async defer src="https://maps.googleapis.com/maps/api/js?AIzaSyDIuLB4OpdqS823hdshWhlHZ04NSlySvvs&callback=initMap"></script>

        
<%- include("../partials/footer.js") %>